# システム運用基本設計書

---

## 文書情報

| 項目 | 内容 |
|------|------|
| システム名 | Dify ワークショップ環境 |
| 版 | 1.0 |
| 作成会社 | 鈴与システムテクノロジー株式会社 |

## 作成・承認履歴

| 役割 | 氏名 | 日付 |
|------|------|------|
| 弊社作成者 | 渡瀬陽己 | 2025-01-30 |
| 弊社確認者 | - | - |
| 弊社承認者 | - | - |

---

## 改訂履歴

| 版 | 改訂内容・改訂経緯 | 作成日 | 作成者 |
|---|---|---|---|
| 1.0 | 新規作成 | 2025-01-30 | 渡瀬 |

## 目次
- [略語説明](#略語説明)
- [1. 基本情報](#1-基本情報)
  - [1-1. アーキテクチャ図（構成図）](#1-1-アーキテクチャ図構成図)
  - [1-2. 運用スケジュール](#1-2-運用スケジュール)
    - [1-2-1. システム稼働時間](#1-2-1-システム稼働時間)
    - [1-2-2. システム停止](#1-2-2-システム停止)
  - [1-3. 運用体制](#1-3-運用体制)
- [2. 基本構成](#2-基本構成)
  - [2-1. 基本構成図](#2-1-基本構成図)
  - [2-2. ネットワーク要件](#2-2-ネットワーク要件)
  - [2-3. リソース情報](#2-3-リソース情報)
- [3. 基盤](#3-基盤)
- [4. ネットワーク](#4-ネットワーク)
- [5. リソース情報](#5-リソース情報)
- [6. 障害対策](#6-障害対策)
- [7. セキュリティ](#7-セキュリティ)
- [8. 監視](#8-監視)

## 略語説明

本資料では記述の簡略化のため、製品や会社名に略称を使用する。各略称の一覧を以下に示す。

| 略称 | 正式名称 | 備考 |
|------|----------|------|
| 当システム | Dify ワークショップ環境 | - |
| SST | 鈴与システムテクノロジー株式会社 | 当社名 |
| AWS | Amazon Web Services | Amazonが提供するクラウドサービス |
| ALB | Application Load Balancer | アプリケーションロードバランサー |
| VPC | Virtual Private Cloud | 仮想プライベートクラウド |
| IGW | Internet Gateway | インターネットゲートウェイ |
| NAT | Network Address Translation | ネットワークアドレス変換 |
| VGW | Virtual Private Gateway | 仮想プライベートゲートウェイ |
| ACM | AWS Certificate Manager | SSL証明書管理サービス |
| DX | AWS Direct Connect | 専用線接続サービス |

## 1. 基本情報

本章では、当システムに関するシステム構成図、運用スケジュール、および運用体制について記載する。

### 1-1. アーキテクチャ図（構成図）

当システムにおけるアーキテクチャ図（構成図）を示す。

※各種サービス情報については、「5.リソース情報」内のリソース一覧を参照すること。

### 1-2. 運用スケジュール

当システムにおける運用スケジュールは、以下の通り定める。

#### 1-2-1. システム稼働時間

当システムの稼働時間は以下の通りとする。
なお、本番環境・PRE環境は、AWSアカウントを分けて運用するものとする。

| No. | 環境 | 対象機能 | 稼働時間 |
|-----|------|----------|----------|
| 1 | ワークショップ | Difyアプリケーション | ワークショップ期間中 |
| 2 | ワークショップ | AI機能（Bedrock） | ワークショップ期間中 |
| 3 | 検証 | Difyアプリケーション | 事前検証時のみ |

#### 1-2-2. システム停止

準備期間およびワークショップ当日は、9:00～18:00の間システムを稼働し、それ以外の時間は停止するものとする。
AWS側のメンテナンス/アップデートに伴い、システム停止が発生する可能性がある。
その場合は、ワークショップ講師および参加学生に迅速に通知し、代替手段を提供する。

### 1-3. 運用体制

当システムにおける運用体制は、以下の通り定める。

#### 責任分界点

| 作業項目 | 開発者 | 講師 |
|---|---|---|
| インフラ構築・運用 | ○ | - |
| 環境準備・設定 | ○ | ○ |
| ワークショップ進行 | - | ○ | 



## 2. 基本構成

### 設計内容

当システムは、学生向けDifyワークショップのための教育環境である。
Difyプラットフォームを使用して、学生がノーコード/ローコードでAIアプリケーション開発を学習できる実習環境を提供する。


#### システム構成
- **フロントエンド**: dify-web（React.js）
- **バックエンド**: dify-api（Python Flask）
- **ワーカー**: dify-worker（バックグラウンド処理）
- **キャッシュ**: Redis（セッション・キャッシュ管理）
- **データベース**: SQLite（軽量データベース）
- **AI機能**: Amazon Bedrock Claude 3.7 Sonnet

本書では、Dify学習に最適化されたワークショップ環境の基本構成について記載する。
インフラ部分は運用者が管理し、講師・学習者がDifyの機能習得に集中できる環境を提供する。

### 2-1. 基本構成図

（構成図を記載）

### 2-2. ネットワーク要件

基本構成図を基に、発生する通信要件の詳細は「4.ネットワーク」を確認。

### 2-3. リソース情報

AWSクラウド上に構築する各リソースの数や用途を「5.リソース情報」にまとめる。

## 3. 基盤

本章では、当システムが稼働基盤として利用するAWSの採用理由およびAWSの機材設置場所環境について記載する。

### 3-1. AWSの採用理由

当システムでは、以下にあげる3つの観点からAWSを採用している。

#### ①セキュリティ・SSL証明書管理
- ACM（AWS Certificate Manager）による自動SSL証明書管理
- ALBでのSSL終端処理によるHTTPS通信の実現
- 証明書の自動更新によるセキュアな通信の継続

#### ②AI機能統合
- Amazon Bedrockによる生成AI機能の提供
- AWS内でのシームレスなAI連携
- 最新のClaude 3.7 Sonnetモデルへのアクセス

#### ③運用・管理効率
- CloudWatchによる統合監視
- Session Managerによるセキュアな管理アクセス
- VPCによるネットワーク分離とセキュリティ確保

### 3-2. 機材設置場所環境

AWS責任共有モデルより、ハードウェア設置、構成はAWSの責任所在下となる。
以下のリージョンのデータセンターにてサーバ管理を実施する。

**使用リージョン：** 東京リージョン（ap-northeast-1）

**※参考URL：** https://aws.amazon.com/jp/blogs/news/rethinksharedresponsibility/

## 4. ネットワーク

本章では、当システムのネットワーク基盤、システムの接続先情報、および通信要件一覧を記載する。

### 4-1. ネットワーク構成概要

本システムでは、Difyを使用するワークショップの参加者はインターネットからDifyの環境に接続し、参加者へのメール通知は、AWS Direct Connectを経由した社内SMTPサーバーとの専用線接続により実現する。

#### システム構成
- **VPC**: カスタムVPC（プライベートクラウド環境）
- **パブリックサブネット**: ALB配置用（2AZ）
- **プライベートサブネット**: EC2配置用
- **インターネット接続**: Internet Gateway（パブリック）、NAT Gateway（プライベート）
- **社内接続**: Virtual Private Gateway + Direct Connect（SMTP通信用）

### 4-2. 主要通信要件

当システムの主要通信は以下の通りとする。

| 通信種別 | 接続元 | 接続先 | プロトコル | 経由 |
| --- | --- | --- | --- | --- |
| Web通信 | 学生・講師 | ALB | HTTPS/443 | インターネット |
| アプリ通信 | ALB | EC2 | HTTP/80 | VPC内部 |
| AI通信 | EC2 | Bedrock | HTTPS/443 | NAT Gateway |
| 通知メール | EC2 | 社内SMTP(10.114.2.8) | SMTP/25 | VGW + Direct Connect |
| 管理通信 | 運用者 | EC2 | Session Manager | AWS Systems Manager |

### 4-3. セキュリティ方針

- **通信暗号化**: 全ての外部通信はTLS1.2以上で暗号化
- **アクセス制御**: セキュリティグループによる最小権限の原則
- **ネットワーク分離**: パブリック・プライベートサブネットによる適切な分離
- **認証**: 招待制ユーザー登録による学習環境保護

## 5. リソース情報

本章では、システムで使用するリソース情報について、機能ごとの構成とリソース一覧を記載する。

### 5-1. インフラ構成

当システムの構成要素について、以下のとおり定義する。
なお、当システムはAWSの東京リージョンに構築を行う。

### 【ネットワーク】
| リソース名 | 数量 | 用途 | 
| --- | --- | --- |
| VPC | 1 | Difyワークショップ環境を構築するネットワーク環境の提供 |
| パブリックサブネット | 2 | ALBを配置するためのネットワーク区画（2AZ） |
| プライベートサブネット | 1 | EC2インスタンスを配置するためのネットワーク区画 |
| インターネットゲートウェイ | 1 | ALBのインターネット接続 |
| NAT Gateway | 1 | EC2インスタンスの外部通信 |
| Virtual Private Gateway | 1 | 社内SMTP接続用（Direct Connect経由） |

ネットワーク環境に関しては、弊社ネットワークサポート部によって構築済みの環境を使用する

### 【コンピューティング】
| リソース名 | 数量 | 用途 |
|---|---|---|
| EC2インスタンス（t3.medium） | 1 | Difyワークショップ実行環境 |
| EBS（30GB gp3） | 1 | EC2インスタンスのストレージ |
| Application Load Balancer | 1 | SSL終端処理・HTTPS通信の実現 |

### 【その他サービス】
| リソース名 | 数量 | 用途 |
|---|---|---|
| Route 53 | 1 | DNS管理 |
| AWS Certificate Manager | 1 | SSL証明書管理 |
| Amazon Bedrock | 1 | AI機能（Claude 3.7 Sonnet） |

### 5-2. リソース一覧

当システムで使用するサービスは以下の通りである。

| AWSサービス | 略称 | 提供範囲 | 役割・その他 |
|---|---|---|---|
| Amazon EC2 | － | リージョン依存 | Difyワークショップの実行環境<br>Docker環境でマイクロサービス構成 |
| Application Load Balancer | ALB | リージョン依存 | 外部からのHTTPS通信を受け付け、EC2に転送<br>SSL終端処理 |
| Amazon VPC | － | リージョン依存 | プライベートネットワーク環境<br>セキュリティグループによるアクセス制御 |
| Internet Gateway | IGW | リージョン依存 | VPCとインターネット間の通信<br>パブリックサブネットのインターネット接続 |
| Route 53 | － | グローバル | DNS管理サービス<br>ドメイン名の解決 |
| AWS Certificate Manager | ACM | リージョン依存 | SSL/TLS証明書の管理<br>HTTPS通信を可能にし、ALBに証明書を適用 |
| Amazon Bedrock | － | リージョン依存 | 生成AI機能<br>Claude 3.7 SonnetによるAI機能 |
| NAT Gateway | － | リージョン依存 | プライベートサブネットからの外部通信<br>Bedrock・パッケージ更新用 |
| Virtual Private Gateway | VGW | リージョン依存 | 社内ネットワーク接続<br>Direct Connect経由SMTP通信用 |

## 6. 障害対策

本章では、物理障害に対する対策、可用性ゾーン（AZ）の冗長性、マルチリージョン展開、およびバックアップといった4つの側面からシステムの障害対策を記載する。

### 6-1. 物理障害

AWS責任共有モデルにより、当システムの物理障害における対策はAWSの所在とする。
AWSの管理するホストOSは冗長化されているため、可用性が確保できている。

### 6-2. AZ冗長

・ワークショップ環境
ALBは2つのAZに配置し、ワークショップ期間中の可用性を確保する。
EC2インスタンスは単一AZ配置とし、コストを最適化する。

・検証環境
検証環境では、AZ冗長構成をとらない。

### 6-3. マルチリージョン

本システムでは、マルチリージョン構成をとらない。

### 6-4. バックアップ

当システムのサーバ、データリソースに対するバックアップ方針を定める。

#### バックアップ対象
| 対象 | バックアップ方法 | 頻度 | 保持期間 |
|---|---|---|---|
| EC2インスタンス | EBSスナップショット | ワークショップ開始前 | ワークショップ終了まで |
| 学習データ | ファイルバックアップ | ワークショップ終了時 | 3ヶ月間 |
| Dify設定ファイル | S3バックアップ | ワークショップ開始前 | ワークショップ終了まで |

また、バックアップ設定による本システムの可用性は下記の通りとなる。

| リソース | RPO | RTO |
|---|---|---|
| EC2インスタンス | 最大24時間 | 30分 |
| SQLiteデータベース | 最大24時間 | 15分 |

### 6-5. DRサイトへの切替

当システムはDRサイトの構築を行わない。

## 7. セキュリティ

### 7-1. 暗号化

#### 通信暗号化
| 通信種別 | 暗号化方式 | 適用範囲 | 備考 |
|----------|------------|----------|------|
| HTTPS通信 | TLS 1.2以上 | ALB - 利用者間 | ACM証明書使用 |
| 内部通信 | HTTP | ALB - EC2間 | VPC内で隔離 |
| AI通信 | TLS 1.2以上 | EC2 - Bedrock間 | AWS標準 |
| SMTP通信 | SMTP | EC2 - 社内SMTP間 | VGW + Direct Connect経由 |

#### データ暗号化
| データ種別 | 暗号化方式 | 適用タイミング | 備考 |
|------------|------------|----------------|------|
| EBSボリューム | AES-256 | 保存時 | AWS標準 |
| SQLiteデータベース | ファイルレベル暗号化 | 保存時 | アプリケーションレベル |

### 7-2. ネットワークセキュリティ

#### セキュリティグループ設計方針
- **最小権限の原則**: 必要最小限のポート・プロトコルのみ許可
- **送信元制限**: 可能な限り特定IPアドレス/CIDR範囲で制限

#### ネットワーク分離
| 分離レベル | 実装方法 | 適用対象 |
|------------|----------|----------|
| サブネット分離 | パブリック/プライベート | ALB・EC2分離 |
| セキュリティグループ分離 | 役割別SG | ALB・EC2・管理用 |

### 7-3. アクセス制御

#### 認証・認可
| 認証レベル | 実装方法 | 適用対象 |
|------------|----------|----------|
| アプリケーション認証 | 招待制ユーザー登録 | Difyアプリケーションレベル |
| 権限分離 | ロールベース | 講師・学生 |

#### 管理アクセス
| アクセス種別 | 認証方式 | 制限事項 |
|--------------|----------|----------|
| EC2管理 | Session Manager | IAMロール必須 |
| AWS Console | IAMユーザー | MFA推奨 |

## 8. 監視

本章では、当システムにおける運用監視の概要について記載する。

### 8-1. 監視の概要

ワークショップ環境の運用監視は、CloudWatchを中心とした監視体制を構築する。

#### 監視項目
| 監視項目 | 監視方法 | 閾値 | アラート条件 |
|---|---|---|---|
| EC2 CPU使用率 | CloudWatch | 80% | 5分間継続 |
| EC2 メモリ使用率 | CloudWatch Agent | 80% | 5分間継続 |
| ALB レスポンス時間 | CloudWatch | 5秒 | 3分間継続 |
| ALB エラー率 | CloudWatch | 5% | 3分間継続 |
| Difyアプリケーション | ヘルスチェック | - | 応答なし時 |
| Bedrock API | CloudWatch | - | エラー発生時 |

#### ログ管理
| ログ種別 | 保存先 | 保持期間 | 用途 |
|----------|--------|----------|------|
| ALBアクセスログ | CloudWatch Logs | 30日 | アクセス解析 |
| EC2システムログ | CloudWatch Logs | 30日 | システム監視 |
| Difyアプリケーションログ | CloudWatch Logs | 30日 | アプリケーション監視 |
| Bedrockアクセスログ | CloudTrail | 90日 | セキュリティ監査 |